package consumidor;
import org.apache.kafka.clients.consumer.*;
import org.apache.kafka.clients.producer.*;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import java.io.File;
import java.nio.file.*;
import java.time.Duration;
import java.util.*;

public class Procesador {
    public static void main(String[] args) {
        // Silenciar logs
        System.setProperty("org.slf4j.simpleLogger.defaultLogLevel", "warn");
        
        new Thread(() -> tareaArchivar()).start();
        new Thread(() -> tareaTransformar()).start();
    }

    static void tareaArchivar() {
        KafkaConsumer<String, String> consumer = crearConsumidor("grupo-archivador");
        consumer.subscribe(Collections.singletonList("cola-recepcion"));
        ObjectMapper mapper = new ObjectMapper();

        System.out.println("üíæ Archivador (RAW) iniciado.");

        while (true) {
            for (ConsumerRecord<String, String> record : consumer.poll(Duration.ofMillis(500))) {
                try {
                    Documento doc = mapper.readValue(record.value(), Documento.class);
                    
                    // REQUISITO: Guardar en carpeta por sender
                    String nombreCarpeta = "archivos_originales/" + doc.sender.replace(" ", "_");
                    new File(nombreCarpeta).mkdirs(); // Crear carpeta si no existe
                    
                    String nombreFichero = nombreCarpeta + "/" + doc.titulo + ".json";
                    Files.write(Paths.get(nombreFichero), record.value().getBytes());
                    
                    System.out.println("üíæ [Archivado] Guardado en disco: " + nombreFichero);
                } catch (Exception e) { e.printStackTrace(); }
            }
        }
    }

    static void tareaTransformar() {
        KafkaConsumer<String, String> consumer = crearConsumidor("grupo-transformador");
        consumer.subscribe(Collections.singletonList("cola-recepcion"));
        
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        ObjectMapper mapper = new ObjectMapper();
        
        System.out.println("‚öôÔ∏è Transformador (Paginador) iniciado.");

        while (true) {
            for (ConsumerRecord<String, String> record : consumer.poll(Duration.ofMillis(500))) {
                try {
                    Documento doc = mapper.readValue(record.value(), Documento.class);
                    String destino = doc.tipo.equals("Color") ? "cola-impresion-color" : "cola-impresion-bn";

                    // REQUISITO: Dividir m√°ximo 400 caracteres
                    String textoCompleto = doc.documento;
                    int longitud = textoCompleto.length();
                    int tamanoPagina = 400;
                    int totalPaginas = (int) Math.ceil((double) longitud / tamanoPagina);

                    for (int i = 0; i < totalPaginas; i++) {
                        int inicio = i * tamanoPagina;
                        int fin = Math.min(inicio + tamanoPagina, longitud);
                        String textoPagina = textoCompleto.substring(inicio, fin);

                        ObjectNode jsonPagina = mapper.createObjectNode();
                        jsonPagina.put("titulo", doc.titulo);
                        jsonPagina.put("pagina", i + 1);
                        jsonPagina.put("total", totalPaginas);
                        jsonPagina.put("contenido", textoPagina);
                        
                        producer.send(new ProducerRecord<>(destino, jsonPagina.toString()));
                    }
                    System.out.println("[Router] " + doc.titulo + " dividido en " + totalPaginas + " p√°gs -> " + destino);

                } catch (Exception e) { e.printStackTrace(); }
            }
        }
    }

    static KafkaConsumer<String, String> crearConsumidor(String grupo) {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("group.id", grupo);
        props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        return new KafkaConsumer<>(props);
    }
}