package consumidor;
import org.apache.kafka.clients.consumer.*;
import org.apache.kafka.clients.producer.*;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;

import modelo.Documento;

import java.io.File;
import java.nio.file.*;
import java.time.Duration;
import java.util.*;

public class Procesador {

    // 1. El Main solo arranca la aplicaci√≥n (limpio)
    public static void main(String[] args) {
        System.setProperty("org.slf4j.simpleLogger.defaultLogLevel", "warn");
        
        Procesador app = new Procesador();
        app.iniciarSistema();
    }

    // 2. M√©todo de instancia que lanza los hilos
    public void iniciarSistema() {
        new Thread(this::tareaArchivar).start();
        new Thread(this::tareaTransformar).start();
    }

    private void tareaArchivar() {
        KafkaConsumer<String, String> consumer = crearConsumidor("grupo-archivador");
        consumer.subscribe(Collections.singletonList("cola-recepcion"));
        ObjectMapper mapper = new ObjectMapper();

        System.out.println("üíæ Archivador listo.");

        while (true) {
            for (ConsumerRecord<String, String> record : consumer.poll(Duration.ofMillis(500))) {
                try {
                    Documento doc = mapper.readValue(record.value(), Documento.class);
                    
                    String nombreCarpeta = "archivos_originales/" + doc.sender.replace(" ", "_");
                    new File(nombreCarpeta).mkdirs();
                    
                    String nombreFichero = nombreCarpeta + "/" + doc.titulo + ".json";
                    Files.write(Paths.get(nombreFichero), record.value().getBytes());
                    
                    System.out.println("üíæ [Archivado] Guardado original: " + doc.titulo);
                } catch (Exception e) { e.printStackTrace(); }
            }
        }
    }

    private void tareaTransformar() {
        KafkaConsumer<String, String> consumer = crearConsumidor("grupo-transformador");
        consumer.subscribe(Collections.singletonList("cola-recepcion"));
        
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        ObjectMapper mapper = new ObjectMapper();
        
        System.out.println("‚öôÔ∏è Transformador listo.");

        while (true) {
            for (ConsumerRecord<String, String> record : consumer.poll(Duration.ofMillis(500))) {
                try {
                    Documento doc = mapper.readValue(record.value(), Documento.class);
                    String destino = doc.tipo.equals("Color") ? "cola-impresion-color" : "cola-impresion-bn";

                    // --- L√ìGICA DE DIVISI√ìN POR P√ÅGINAS ---
                    String texto = doc.documento;
                    int longitud = texto.length();
                    int maxChars = 400; // Seg√∫n enunciado
                    
                    // Calculamos total p√°ginas
                    int totalPaginas = (int) Math.ceil((double) longitud / maxChars);

                    for (int i = 0; i < totalPaginas; i++) {
                        int inicio = i * maxChars;
                        int fin = Math.min(inicio + maxChars, longitud);
                        String contenidoPagina = texto.substring(inicio, fin);

                        // Crear JSON de la p√°gina suelta
                        ObjectNode jsonPagina = mapper.createObjectNode();
                        jsonPagina.put("titulo", doc.titulo);
                        jsonPagina.put("pagina_actual", i + 1);
                        jsonPagina.put("total_paginas", totalPaginas);
                        jsonPagina.put("contenido", contenidoPagina);
                        
                        producer.send(new ProducerRecord<>(destino, jsonPagina.toString()));
                    }
                    System.out.println("üîÄ [Router] " + doc.titulo + " dividido en " + totalPaginas + " p√°ginas -> Enviado a " + destino);

                } catch (Exception e) { e.printStackTrace(); }
            }
        }
    }

    private KafkaConsumer<String, String> crearConsumidor(String grupo) {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("group.id", grupo);
        props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        return new KafkaConsumer<>(props);
    }
}